<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auth State</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-2xl font-bold mb-6">üîç Auth State Diagnostic</h1>
        
        <div class="space-y-4">
            <div>
                <h2 class="font-bold text-lg mb-2">Current User (from Supabase Auth):</h2>
                <pre id="currentUser" class="bg-gray-100 p-4 rounded text-sm overflow-auto"></pre>
            </div>
            
            <div>
                <h2 class="font-bold text-lg mb-2">User Profile (from users table):</h2>
                <pre id="userProfile" class="bg-gray-100 p-4 rounded text-sm overflow-auto"></pre>
            </div>
            
            <div>
                <h2 class="font-bold text-lg mb-2">Session:</h2>
                <pre id="session" class="bg-gray-100 p-4 rounded text-sm overflow-auto"></pre>
            </div>
            
            <div class="flex gap-4">
                <button onclick="refreshData()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    üîÑ Refresh Data
                </button>
                <button onclick="clearCache()" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
                    üóëÔ∏è Clear Cache & Reload
                </button>
                <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                    üö™ Logout
                </button>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/database.js"></script>
    <script>
        async function refreshData() {
            try {
                // Get current user
                const user = await db.auth.getCurrentUser();
                document.getElementById('currentUser').textContent = JSON.stringify(user, null, 2);

                // Get session
                const { data: { session } } = await supabaseClient.auth.getSession();
                document.getElementById('session').textContent = JSON.stringify(session, null, 2);

                // Get user profile - with detailed error logging
                if (user) {
                    console.log('Fetching profile for user ID:', user.id);

                    // Try direct query to see what happens
                    const { data: profileData, error: profileError } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('id', user.id)
                        .single();

                    console.log('Profile query result:', { profileData, profileError });

                    if (profileError) {
                        document.getElementById('userProfile').textContent =
                            'ERROR: ' + JSON.stringify(profileError, null, 2);
                    } else if (profileData) {
                        document.getElementById('userProfile').textContent =
                            JSON.stringify(profileData, null, 2);
                    } else {
                        document.getElementById('userProfile').textContent =
                            'No profile found (data is null)';
                    }
                } else {
                    document.getElementById('userProfile').textContent = 'No user logged in';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        }
        
        function clearCache() {
            localStorage.clear();
            sessionStorage.clear();
            location.reload();
        }
        
        async function logout() {
            await db.auth.signOut();
            location.reload();
        }
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', refreshData);
    </script>
</body>
</html>

