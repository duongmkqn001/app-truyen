<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh s√°ch T√°c gi·∫£ - App Truy·ªán</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <a href="index.html" class="text-2xl font-bold text-green-600">üìö App Truy·ªán</a>
                
                <div class="flex items-center gap-4">
                    <a href="index.html" class="text-gray-700 hover:text-green-600">Trang ch·ªß</a>
                    <a href="authors.html" class="text-green-600 font-semibold">T√°c gi·∫£</a>
                    <a href="search-by-tag.html" class="text-gray-700 hover:text-green-600">T√¨m theo th·ªÉ lo·∫°i</a>
                    <a href="ranking.html" class="text-gray-700 hover:text-green-600">B·∫£ng x·∫øp h·∫°ng</a>
                    <a href="upload.html" class="text-gray-700 hover:text-green-600">T·∫£i l√™n</a>
                    
                    <!-- User Menu -->
                    <div id="userMenu"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">‚úçÔ∏è Danh s√°ch T√°c gi·∫£</h1>
            
            <!-- Search Box -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <input type="text" id="authorSearchInput" 
                       placeholder="T√¨m ki·∫øm t√°c gi·∫£..." 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </div>

            <!-- Authors Count -->
            <div id="authorsCount" class="text-gray-700 mb-4"></div>

            <!-- Authors Grid -->
            <div id="authorsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Loading state -->
                <div class="col-span-full flex justify-center items-center py-12">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto mb-4"></div>
                        <p class="text-gray-600">ƒêang t·∫£i danh s√°ch t√°c gi·∫£...</p>
                    </div>
                </div>
            </div>

            <!-- No Results Message -->
            <div id="noResults" class="hidden text-center py-12">
                <div class="text-6xl mb-4">‚úçÔ∏è</div>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Kh√¥ng t√¨m th·∫•y t√°c gi·∫£</h3>
                <p class="text-gray-500">Th·ª≠ thay ƒë·ªïi t·ª´ kh√≥a t√¨m ki·∫øm</p>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex items-center gap-3">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
            <span class="text-gray-700 font-medium">ƒêang t·∫£i...</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/database.js"></script>
    <script src="js/components.js"></script>
    <script>
        // Use the global supabaseClient from database.js
        let allAuthors = [];
        let filteredAuthors = [];

        // Load authors from database
        async function loadAuthors() {
            try {
                const { data: novels, error } = await supabaseClient
                    .from('novels_with_stats')
                    .select('author_name')
                    .eq('is_approved', true);
                
                if (error) throw error;
                
                // Get unique authors with novel counts
                const authorCounts = {};
                novels.forEach(novel => {
                    const author = novel.author_name;
                    if (author) {
                        authorCounts[author] = (authorCounts[author] || 0) + 1;
                    }
                });
                
                // Convert to array and sort by novel count
                allAuthors = Object.entries(authorCounts)
                    .map(([name, count]) => ({ name, count }))
                    .sort((a, b) => b.count - a.count);
                
                filteredAuthors = [...allAuthors];
                
                displayAuthors();
                initializeSearch();
                
            } catch (error) {
                console.error('Error loading authors:', error);
                document.getElementById('authorsContainer').innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-red-600">
                            <p class="text-lg font-semibold">‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch t√°c gi·∫£</p>
                            <p class="text-sm mt-2">${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        // Display authors
        function displayAuthors() {
            const container = document.getElementById('authorsContainer');
            const noResults = document.getElementById('noResults');
            const countDiv = document.getElementById('authorsCount');
            
            if (filteredAuthors.length === 0) {
                container.innerHTML = '';
                noResults.classList.remove('hidden');
                countDiv.textContent = '';
                return;
            }
            
            noResults.classList.add('hidden');
            countDiv.textContent = `T√¨m th·∫•y ${filteredAuthors.length} t√°c gi·∫£`;
            
            container.innerHTML = filteredAuthors.map(author => `
                <a href="author.html?author=${encodeURIComponent(author.name)}" 
                   class="block bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow p-6 border border-gray-200 hover:border-green-500">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold text-gray-900 truncate mb-1">
                                ${author.name}
                            </h3>
                            <p class="text-sm text-gray-600">
                                üìö ${author.count} truy·ªán
                            </p>
                        </div>
                        <div class="ml-4 flex-shrink-0">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </div>
                </a>
            `).join('');
        }

        // Initialize search
        function initializeSearch() {
            const searchInput = document.getElementById('authorSearchInput');
            
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                
                if (searchTerm === '') {
                    filteredAuthors = [...allAuthors];
                } else {
                    filteredAuthors = allAuthors.filter(author => 
                        author.name.toLowerCase().includes(searchTerm)
                    );
                }
                
                displayAuthors();
            });
        }

        // Initialize authentication
        async function initAuth() {
            const user = await db.auth.getCurrentUser();
            const userMenu = document.getElementById('userMenu');

            if (!user) {
                userMenu.innerHTML = `
                    <a href="login.html" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                        ƒêƒÉng nh·∫≠p
                    </a>
                `;
                return;
            }

            const profile = await db.auth.getUserProfile(user.id);

            userMenu.innerHTML = `
                <div class="flex items-center gap-3">
                    <a href="profile.html" class="text-gray-700 hover:text-green-600">üë§ ${profile?.username || user.email}</a>
                    ${UIComponents.createRoleBadge(profile?.role || 'reader')}
                    ${['admin', 'super_admin', 'sub_admin'].includes(profile?.role) ? '<a href="admin.html" class="text-blue-600 hover:underline">Qu·∫£n tr·ªã</a>' : ''}
                    <button onclick="logout()" class="text-red-600 hover:underline">ƒêƒÉng xu·∫•t</button>
                </div>
            `;
        }

        async function logout() {
            await db.auth.signOut();
            window.location.href = 'index.html';
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
            loadAuthors();
        });
    </script>
</body>
</html>

